# Loop Telegram Bot

Производственный Telegram-бот (aiogram v3) для подбора очков с интеграцией каталога через Google Sheets CSV.

## Требования

- Python 3.10+
- SQLite

## Установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Настройка окружения

Скопируйте `.env.example` → `.env` и заполните значения. В шаблоне у каждой переменной есть комментарий:
- токен бота, ссылка на Google Sheets CSV и URL лендинга;
- лимиты, TTL кэша, параметры напоминаний;
- переключатель мок-генерации и креды NanoBanana;
- пути к папкам `uploads/` и `results/`.

Все переменные подхватываются через `load_config` (`app/config.py`) и превращаются в dataclass `Config`, так что
никаких «спрятанных» параметров нет — правки делаются только в `.env`.

## Коллажи

Подборки моделей отправляются двумя сообщениями-коллажами (формат 2×1) поверх Pillow. Коллаж настраивается через
переменные окружения:

```
COLLAGE_WIDTH=1280
COLLAGE_HEIGHT=640
COLLAGE_GAP=16
COLLAGE_PADDING=24
COLLAGE_BG="#FFFFFF"
COLLAGE_JPEG_QUALITY=90
COLLAGE_FIT_MODE=contain  # варианты: contain | cover
COLLAGE_SHARPEN=0.0       # 0..1, лёгкая резкость
COLLAGE_DIVIDER=6         # толщина вертикальной полосы между фото
COLLAGE_DIVIDER_COLOR="#E6E9EF"
COLLAGE_DIVIDER_RADIUS=0  # px скругления разделителя
COLLAGE_CELL_BORDER=0     # толщина рамки вокруг каждой ячейки (0 = выкл)
COLLAGE_CELL_BORDER_COLOR="#D7DBE4"
```

Параметры отвечают за итоговый размер, отступы, цвет фона и качество JPEG. По умолчанию изображения вписываются по
алгоритму «contain» (без кропа), но можно переключить режим на «cover» через `COLLAGE_FIT_MODE`. Допустимо включить
лёгкую резкость значением `COLLAGE_SHARPEN` (> 0).

### Разделитель и рамки

- `COLLAGE_DIVIDER` + `COLLAGE_DIVIDER_COLOR` рисуют вертикальную полосу между половинами. Скругление задаётся через
  `COLLAGE_DIVIDER_RADIUS` — 0 отключает его.
- `COLLAGE_CELL_BORDER` позволяет обвести каждую ячейку поверх изображения; цвет задаётся в `COLLAGE_CELL_BORDER_COLOR`.
- Для аккуратной нейтральной палитры подойдут оттенки #E6E9EF (разделитель) и #D7DBE4 (рамки), которые не отвлекают от
  самих оправ.

Рекомендации по исходным кадрам:

- Старайтесь хранить фотографии очков в одинаковом соотношении сторон (идеально — квадрат или схожие «ландшафтные»).
- Добивайтесь, чтобы сама оправа занимала 70–85% ширины — так итоговый коллаж получится читаемым.
- PNG с прозрачным фоном подходят: при конвертации в JPEG фон зальётся цветом `COLLAGE_BG`.
- Лучше использовать источники от 1200 px по длинной стороне — Telegram всё равно пережмёт, но детализация сохранится.

## Как работает каталог

- `GoogleSheetCatalog` подтягивает CSV по ссылке публикации Google Таблицы.
- Ответ кэшируется на 60 секунд (можно настроить через `CSV_FETCH_TTL_SEC`), чтобы не ддосить источник.
- Для устойчивости реализован повтор запросов (до `CSV_FETCH_RETRIES` попыток) с экспоненциальной задержкой.
- Каждая карточка преобразует Google Drive `view`-ссылку к прямому URL (`/uc?export=view&id=...`) перед отправкой пользователю.
- Фильтрация идёт по колонке «Пол»; если моделей мало, добавляются «Унисекс».
- Кнопки «Подробнее о модели» открывают ссылку из таблицы.

> ⚠️ Telegram не позволяет программно открыть системный выбор файлов, поэтому пользователю всё равно нужно отправлять фото вручную через стандартную «скрепку» в чате.

## Запуск

```bash
python -m app.main
```

Бот использует long polling. При старте создаются директории `uploads/` и `results/`, а каталог очков подгружается из Google Sheets.

## Тесты

```bash
pytest
```

## Архитектура

- `app/services/catalog_google.py` — сервис каталога с кэшем и retry.
- `app/services/repository.py` — SQLite-хранилище пользователей и дневных лимитов.
- `app/services/tryon_mock.py` — mock-генерация результатов (белые изображения).
- `app/fsm.py` — конечный автомат aiogram, который обращается к каталогу и управляет UX.
- `app/texts/messages.py` — единый файл с текстами и подписями для нетехнарей.
- `app/utils/drive.py` — преобразование ссылок Google Drive.

## План развития

- Интеграция NanoBanana вместо mock-сервиса.
- Подключение реального стора для выдачи превью пользователю.
