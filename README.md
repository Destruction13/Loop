# Loop Telegram Bot

Производственный Telegram-бот (aiogram v3) для подбора очков с интеграцией каталога через Google Sheets CSV.

## Требования

- Python 3.10+
- SQLite

## Установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Настройка окружения

Скопируйте `.env.example` → `.env` и заполните значения. Поддерживаются только 10 переменных окружения:

- `BOT_TOKEN` — токен бота от @BotFather;
- `SHEET_CSV_URL` — публичная CSV-ссылка Google Sheets для каталога;
- `LANDING_URL` — ссылка «Записаться» из бота;
- `SOCIAL_LINKS_JSON` — JSON-массив ссылок на соцсети (каждый элемент `{"title","url"}`);
- `PROMO_CODE` — текст промокода, подставляется в сообщения;
- `DAILY_TRY_LIMIT` — лимит примерок в сутки для пользователя;
- `CATALOG_ROW_LIMIT` — ограничение на количество строк каталога (0 = без ограничения);
- `PICK_SCHEME` — стратегия выдачи (по умолчанию `UNIVERSAL`);
- `GOOGLE_SHEET_URL` — URL основной таблицы (для экспорта лидов и вычисления sheet_id);
- `GOOGLE_SERVICE_ACCOUNT_JSON` — путь к JSON-файлу сервисного аккаунта Google.

Все остальные параметры зашиты в коде `load_config` (`app/config.py`) и имеют стабильные значения.

Пример заполнения блока соцсетей:

```
SOCIAL_LINKS_JSON=[
  {"title":"Instagram","url":"https://www.instagram.com/your_profile"},
  {"title":"VK","url":"https://vk.com/your_page"}
]
```

Количество кнопок в боте автоматически соответствует количеству элементов массива.

## Коллажи

Коллаж отправляется одним сообщением формата **1×2** (две плитки). Настройки зашиты в коде и повторяют прежние значения,
которые раньше задавались через `.env`:

- `batch_size = 2`, `batch_layout_cols = 2`, базовая схема подбора по умолчанию — `UNIVERSAL`;
- размеры плитки: `slot_width=1080`, `slot_height=1440`, разделитель `24px`, отступы `0`;
- цвета: фон `#000000`, разделитель `#2A2A2A`;
- формат вывода `PNG`, качество JPEG-пресета `90` (используется при конвертации).

Изображения вписываются в плитки с сохранением пропорций; если моделей меньше `batch_size`, пустые места остаются чёрными.

## Как работает каталог

- `GoogleSheetCatalog` подтягивает CSV по ссылке публикации Google Таблицы.
- Ответ кэшируется на 60 секунд (значение зашито в коде) — этого достаточно, чтобы не ддосить источник.
- Для устойчивости используется до трёх повторных попыток с экспоненциальной задержкой — параметр также фиксирован.
- Каждая карточка преобразует Google Drive `view`-ссылку к прямому URL (`/uc?export=view&id=...`) перед отправкой пользователю.
- Фильтрация идёт по колонке «Пол»; если моделей мало, добавляются «Унисекс».
- Кнопки «Подробнее о модели» открывают ссылку из таблицы.

> ⚠️ Telegram не позволяет программно открыть системный выбор файлов, поэтому пользователю всё равно нужно отправлять фото вручную через стандартную «скрепку» в чате.

## Запуск

```bash
python -m app.main
```

Бот использует long polling. При старте создаются директории `uploads/` и `results/`, а каталог очков подгружается из Google Sheets.

## Тесты

```bash
pytest
```

## Архитектура

- `app/services/catalog_google.py` — сервис каталога с кэшем и retry.
- `app/services/repository.py` — SQLite-хранилище пользователей и дневных лимитов.
- `app/services/nanobanana.py` — клиент NanoBanana (Gemini) для генерации примерок.
- `app/fsm.py` — конечный автомат aiogram, который обращается к каталогу и управляет UX.
- `app/texts/messages.py` — единый файл с текстами и подписями для нетехнарей.
- `app/utils/drive.py` — преобразование ссылок Google Drive.

## План развития

- Интеграция NanoBanana вместо mock-сервиса.
- Подключение реального стора для выдачи превью пользователю.
