# Loop Telegram Bot

Производственный Telegram-бот (aiogram v3) для подбора очков с интеграцией каталога через Google Sheets CSV.

## Требования

- Python 3.10+
- SQLite

## Установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Настройка окружения

Скопируйте `.env.example` → `.env` и заполните значения. В шаблоне у каждой переменной есть комментарий:
- токен бота, ссылка на Google Sheets CSV и URL лендинга;
- лимиты, TTL кэша, параметры напоминаний;
- переключатель мок-генерации и креды NanoBanana;
- пути к папкам `uploads/` и `results/`.

Все переменные подхватываются через `load_config` (`app/config.py`) и превращаются в dataclass `Config`, так что
никаких «спрятанных» параметров нет — правки делаются только в `.env`.

## Как работает каталог

- `GoogleSheetCatalog` подтягивает CSV по ссылке публикации Google Таблицы.
- Ответ кэшируется на 60 секунд (можно настроить через `CSV_FETCH_TTL_SEC`), чтобы не ддосить источник.
- Для устойчивости реализован повтор запросов (до `CSV_FETCH_RETRIES` попыток) с экспоненциальной задержкой.
- Каждая карточка преобразует Google Drive `view`-ссылку к прямому URL (`/uc?export=view&id=...`) перед отправкой пользователю.
- Фильтрация идёт по колонке «Пол»; если моделей мало, добавляются «Унисекс».
- Кнопки «Подробнее о модели» открывают ссылку из таблицы.

> ⚠️ Telegram не позволяет программно открыть системный выбор файлов, поэтому пользователю всё равно нужно отправлять фото вручную через стандартную «скрепку» в чате.

## Запуск

```bash
python -m app.main
```

Бот использует long polling. При старте создаются директории `uploads/` и `results/`, а каталог очков подгружается из Google Sheets.

## Тесты

```bash
pytest
```

## Архитектура

- `app/services/catalog_google.py` — сервис каталога с кэшем и retry.
- `app/services/repository.py` — SQLite-хранилище пользователей и дневных лимитов.
- `app/services/tryon_mock.py` — mock-генерация результатов (белые изображения).
- `app/fsm.py` — конечный автомат aiogram, который обращается к каталогу и управляет UX.
- `app/texts/messages.py` — единый файл с текстами и подписями для нетехнарей.
- `app/utils/drive.py` — преобразование ссылок Google Drive.

## План развития

- Интеграция NanoBanana вместо mock-сервиса.
- Подключение реального стора для выдачи превью пользователю.
